---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageHeader from "../../components/PageHeader.astro";
import CoverCardGrid from "../../components/CoverCardGrid.astro";
import { supabase } from "../../lib/supabase";
import { TAGS } from "../../types/tags";
import type { Enums } from "../../types/types";
import Tag from "../../components/Tag.astro";

const { slug } = Astro.params;

const tag: Enums<"tags"> | undefined = Object.keys(TAGS).find(
  (key) => TAGS[key as Enums<"tags">].slug === slug
) as Enums<"tags"> | undefined;

if (!tag) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const { data } = await supabase
  .from("covers")
  .select(
    `
    slug,
    original:original_id(id, name, artists, album_name, album_img),
    cover:cover_id(id, name, artists, album_name, album_img)
  `
  )
  .order("created_at", { ascending: false })
  .overlaps("tags", [tag]);

if (!data) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const title = `Tagged “${TAGS[tag].label}”`;
const description = TAGS[tag].description;
---

<BaseLayout title={`${title} on Genderswap.fm`} description={description}>
  <PageHeader title={title} description={description}>
    <Tag text="Explore all tags" url="/tagged" />
  </PageHeader>
  <CoverCardGrid covers={data as any} />
</BaseLayout>
